<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - Package Tracking</title>
    <link rel="icon" type="image/jpeg" href="/Logos/logo.jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #e0e7ff;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background-color: var(--bg-card);
            box-shadow: var(--shadow-sm);
            padding: 0 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 70px;
            display: flex;
            align-items: center;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .logo-small {
            height: 32px;
            width: 32px;
            border-radius: 6px;
        }

        .nav-menu {
            display: flex;
            gap: 1rem;
            list-style: none;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .nav-link:hover {
            color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 6rem auto 2rem;
            padding: 0 1.5rem;
        }

        .card {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            transition: all 0.2s;
            background-color: #f9fafb;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background-color: #fff;
        }

        textarea.form-input {
            font-family: 'Courier New', monospace;
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: white;
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #fef2f2;
        }

        .btn-secondary {
            background-color: white;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #f9fafb;
            color: var(--text-primary);
        }

        /* Provider List */
        .provider-list {
            display: grid;
            gap: 1rem;
        }

        .provider-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            transition: all 0.2s;
        }

        .provider-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        .provider-info {
            flex: 1;
        }

        .provider-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.05rem;
            margin-bottom: 0.25rem;
        }

        .provider-url {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-family: monospace;
            background: #f1f5f9;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            display: inline-block;
        }

        .provider-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .api-config-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 1rem;
            background-color: #f8fafc;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            transition: background-color 0.2s;
            border: 1px solid var(--border-color);
        }

        .collapsible-header:hover {
            background-color: #f1f5f9;
        }

        .collapsible-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .collapse-icon {
            transition: transform 0.3s;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .collapse-icon.expanded {
            transform: rotate(180deg);
        }

        .collapsible-content {
            display: none;
            padding: 1rem 0;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .collapsible-content.show {
            display: block;
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.35rem;
        }

        .json-error {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
            font-weight: 500;
        }

        /* Notifications */
        .message {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            display: none;
            font-weight: 500;
        }

        .message.success {
            background-color: #ecfdf5;
            color: #047857;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background-color: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
            }

            .nav-menu {
                display: none;
                position: fixed;
                top: 70px;
                left: 0;
                right: 0;
                background-color: white;
                padding: 1rem;
                flex-direction: column;
                box-shadow: var(--shadow);
            }

            .nav-menu.active {
                display: flex;
            }

            .mobile-menu-btn {
                display: block;
            }

            .container {
                margin-top: 5rem;
                padding: 0 1rem;
            }

            .provider-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .provider-actions {
                margin-left: 0;
                width: 100%;
                justify-content: flex-end;
                border-top: 1px solid var(--border-color);
                padding-top: 1rem;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <nav class="nav-container">
            <a href="/admin" class="logo-container">
                <img src="/Logos/logo.jpeg" alt="Logo" class="logo-small">
                <span>Admin Dashboard</span>
            </a>
            <ul class="nav-menu">
                <li><a href="/admin" class="nav-link">Dashboard</a></li>
                <li><a href="/config" class="nav-link active">Configuration</a></li>
                <li><a href="#" class="nav-link" onclick="handleLogout()">Logout</a></li>
            </ul>
            <button class="mobile-menu-btn" aria-label="Toggle menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
        </nav>
    </header>

    <div class="container">
        <div class="message" id="message"></div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Tracking Providers</h2>
            </div>
            <div class="card-body">
                <div class="provider-list" id="providerList">
                    <!-- Provider items will be added here dynamically -->
                </div>

                <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; color: var(--text-primary);">Add / Edit
                        Provider</h3>

                    <form id="providerForm" onsubmit="return handleFormSubmit(event)">
                        <div class="form-group">
                            <label class="form-label" for="providerId">Provider ID</label>
                            <input type="text" id="providerId" class="form-input" readonly placeholder="Auto-generated"
                                style="background-color: #f1f5f9; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="providerName">Provider Name</label>
                            <input type="text" id="providerName" class="form-input" required
                                placeholder="Enter provider name" />
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="trackingUrl">Tracking URL Template</label>
                            <input type="text" id="trackingUrl" class="form-input" required
                                placeholder="e.g. https://www.ups.com/track?loc=en_US&tracknum={trackingId}" />
                            <div class="help-text">Use <code>{trackingId}</code> as a placeholder for the tracking
                                number.</div>
                        </div>

                        <!-- API Configuration Section -->
                        <div class="api-config-section">
                            <div class="collapsible-header" onclick="toggleApiConfig()">
                                <h3>API Configuration (Optional)</h3>
                                <span class="collapse-icon" id="collapseIcon">â–¼</span>
                            </div>
                            <div class="collapsible-content" id="apiConfigContent">
                                <div class="form-group">
                                    <label class="form-label" for="apiEndpoint">API Endpoint</label>
                                    <input type="text" id="apiEndpoint" class="form-input"
                                        placeholder="https://api.provider.com/track" />
                                    <div class="help-text">The API endpoint URL for tracking requests</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="apiMethod">HTTP Method</label>
                                    <select id="apiMethod" class="form-input">
                                        <option value="POST">POST</option>
                                        <option value="GET">GET</option>
                                        <option value="PUT">PUT</option>
                                        <option value="PATCH">PATCH</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="apiHeaders">Request Headers (JSON)</label>
                                    <textarea id="apiHeaders" class="form-input"
                                        placeholder='{"Content-Type": "application/json", "Authorization": "Bearer token"}'></textarea>
                                    <div class="help-text">Enter headers as a JSON object</div>
                                    <div class="json-error" id="headersError">Invalid JSON format</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="apiRequestBody">Request Body Template (JSON)</label>
                                    <textarea id="apiRequestBody" class="form-input"
                                        placeholder='{"trackNumber": "{trackingId}"}'></textarea>
                                    <div class="help-text">Use <code>{trackingId}</code> as a placeholder for the
                                        tracking number</div>
                                    <div class="json-error" id="bodyError">Invalid JSON format</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem;">
                            <button type="submit" class="btn btn-primary">Add Provider</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()"
                                style="margin-left: 0.5rem;">Reset</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load providers on page load
        window.onload = loadProviders;

        // Load providers from the server
        async function loadProviders() {
            try {
                const response = await fetch('/api/providers');
                const providers = await response.json();
                displayProviders(providers);
            } catch (error) {
                console.error('Error loading providers:', error);
                showMessage('Failed to load providers', 'error');
            }
        }

        // Display providers in the list
        function displayProviders(providers) {
            const providerList = document.getElementById('providerList');
            if (providers.length === 0) {
                providerList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No providers configured yet.</div>';
                return;
            }

            providerList.innerHTML = providers.map(provider => `
                <div class="provider-item">
                    <div class="provider-info">
                        <div class="provider-name">${provider.name}</div>
                        <div class="provider-url" title="${provider.trackingUrl}">${provider.trackingUrl}</div>
                    </div>
                    <div class="provider-actions">
                        <button class="btn btn-secondary" onclick="editProvider('${provider._id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteProvider('${provider._id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Toggle API Configuration section
        function toggleApiConfig() {
            const content = document.getElementById('apiConfigContent');
            const icon = document.getElementById('collapseIcon');
            content.classList.toggle('show');
            icon.classList.toggle('expanded');
        }

        // Validate JSON input
        function validateJSON(text, errorElementId) {
            const errorElement = document.getElementById(errorElementId);
            if (!text.trim()) {
                errorElement.style.display = 'none';
                return true;
            }
            try {
                JSON.parse(text);
                errorElement.style.display = 'none';
                return true;
            } catch (e) {
                errorElement.style.display = 'block';
                return false;
            }
        }

        // Add event listeners for JSON validation
        document.addEventListener('DOMContentLoaded', () => {
            const headersTextarea = document.getElementById('apiHeaders');
            const bodyTextarea = document.getElementById('apiRequestBody');

            if (headersTextarea) {
                headersTextarea.addEventListener('blur', () => {
                    validateJSON(headersTextarea.value, 'headersError');
                });
            }

            if (bodyTextarea) {
                bodyTextarea.addEventListener('blur', () => {
                    validateJSON(bodyTextarea.value, 'bodyError');
                });
            }
        });

        // Edit provider
        async function editProvider(id) {
            try {
                console.log('ðŸ” Fetching provider details for ID:', id);
                const response = await fetch(`/api/providers/${id}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch provider details');
                }
                const provider = await response.json();

                // Populate the form
                document.getElementById('providerId').value = provider._id;
                document.getElementById('providerName').value = provider.name;
                document.getElementById('trackingUrl').value = provider.trackingUrl;

                // Populate API configuration if available
                if (provider.apiConfig) {
                    document.getElementById('apiEndpoint').value = provider.apiConfig.endpoint || '';
                    document.getElementById('apiMethod').value = provider.apiConfig.method || 'POST';

                    // Convert Map to JSON for headers
                    if (provider.apiConfig.headers) {
                        const headers = typeof provider.apiConfig.headers === 'object'
                            ? provider.apiConfig.headers
                            : Object.fromEntries(provider.apiConfig.headers);
                        document.getElementById('apiHeaders').value = JSON.stringify(headers, null, 2);
                    }

                    document.getElementById('apiRequestBody').value = provider.apiConfig.requestBodyTemplate || '';

                    // Expand API config section if there's data
                    if (provider.apiConfig.endpoint) {
                        const content = document.getElementById('apiConfigContent');
                        const icon = document.getElementById('collapseIcon');
                        content.classList.add('show');
                        icon.classList.add('expanded');
                    }
                }

                // Update form button text
                document.getElementById('providerForm').querySelector('button[type="submit"]').textContent = 'Update Provider';

                // Scroll to form
                document.getElementById('providerForm').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error fetching provider details:', error);
                showMessage('Failed to load provider details', 'error');
            }
        }

        function resetForm() {
            document.getElementById('providerForm').reset();
            document.getElementById('providerId').value = '';
            document.getElementById('providerForm').querySelector('button[type="submit"]').textContent = 'Add Provider';
            const content = document.getElementById('apiConfigContent');
            const icon = document.getElementById('collapseIcon');
            content.classList.remove('show');
            icon.classList.remove('expanded');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const providerId = document.getElementById('providerId').value;
            const name = document.getElementById('providerName').value.trim();
            const trackingUrl = document.getElementById('trackingUrl').value.trim();

            if (!name || !trackingUrl) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }

            // Get API configuration
            const apiEndpoint = document.getElementById('apiEndpoint').value.trim();
            const apiMethod = document.getElementById('apiMethod').value;
            const apiHeadersText = document.getElementById('apiHeaders').value.trim();
            const apiRequestBodyText = document.getElementById('apiRequestBody').value.trim();

            // Validate JSON fields
            if (apiHeadersText && !validateJSON(apiHeadersText, 'headersError')) {
                showMessage('Invalid JSON format in headers', 'error');
                return;
            }

            if (apiRequestBodyText && !validateJSON(apiRequestBodyText, 'bodyError')) {
                showMessage('Invalid JSON format in request body', 'error');
                return;
            }

            try {
                const url = providerId ? `/api/providers/${providerId}` : '/api/providers';
                const method = providerId ? 'PUT' : 'POST';

                const payload = { name, trackingUrl };

                // Add API configuration if provided
                if (apiEndpoint) {
                    payload.apiConfig = {
                        endpoint: apiEndpoint,
                        method: apiMethod,
                        headers: apiHeadersText ? JSON.parse(apiHeadersText) : {},
                        requestBodyTemplate: apiRequestBodyText
                    };
                }

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save provider');
                }

                // Reset form
                resetForm();

                // Reload providers
                await loadProviders();
                showMessage(providerId ? 'Provider updated successfully' : 'Provider added successfully', 'success');
            } catch (error) {
                console.error('Error saving provider:', error);
                showMessage(error.message, 'error');
            }
        }

        // Delete provider
        async function deleteProvider(id) {
            if (!confirm('Are you sure you want to delete this provider?')) {
                return;
            }

            try {
                const response = await fetch(`/api/providers/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Provider deleted successfully', 'success');
                    loadProviders();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to delete provider', 'error');
                }
            } catch (error) {
                console.error('Error deleting provider:', error);
                showMessage('An error occurred while deleting the provider', 'error');
            }
        }

        // Show message
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';

            // Clear message after 5 seconds
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = 'message';
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Logout function
        async function handleLogout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Mobile menu functionality
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const navMenu = document.querySelector('.nav-menu');

        mobileMenuBtn.addEventListener('click', () => {
            navMenu.classList.toggle('active');
            // Toggle aria-expanded attribute
            const isExpanded = navMenu.classList.contains('active');
            mobileMenuBtn.setAttribute('aria-expanded', isExpanded);
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (event) => {
            if (!navMenu.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                navMenu.classList.remove('active');
                mobileMenuBtn.setAttribute('aria-expanded', 'false');
            }
        });

        navMenu.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                navMenu.classList.remove('active');
                mobileMenuBtn.setAttribute('aria-expanded', 'false');
            });
        });
    </script>
</body>

</html>